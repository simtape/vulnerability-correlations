import json
import requests
from dotenv import load_dotenv
import os
import traceback
import sys
from requests import Response

load_dotenv()

FOLDER_PACKAGES = "data/packages/"
FOLDER_VULNERABILITIES = "data/vulnerabilities/"
BASE_URL = "https://public.vulnerablecode.io/api/"

headers = {'Content-type': 'application/json',
           'Authorization': os.getenv("API_KEY"),
           "Connection": 'keep-alive',
           'Accept-encoding': "gzip, deflate, br",
           "Accept": "*/*"
           }

"""
extracts, from a json containing all packages in the db of vulnerablecode.io, 
only the base names of the pkgs(ex. pkg:alpine).
saves on json the list of the names.
"""
def extract_packages_names() -> None:
    try:
        f = open(FOLDER_PACKAGES + 'all-packages.json')
    except FileNotFoundError:
        print("File not existing")

    data = json.load(f)

    packages = json.load(f)
    pkg_names = []

    for package in packages:
        pkg_name = ""
        print(package)
        idx = 0
        while package[idx] != "/":
            pkg_name = pkg_name + package[idx]
            idx += 1

        if pkg_name not in pkg_names:
            pkg_names.append(pkg_name)

    with open(FOLDER_PACKAGES + "names-packages.json", "w") as outfile:
        json.dump(pkg_names, outfile)


"""
GET request to vulnerablecode api
by name of the package
"""


def get_package_data_by_name(pkg_type: str, url: str, fixed: bool) -> Response:
    params = {"type": pkg_type, "page_size": 500000, "packagerelatedvulnerability__fix": fixed}
    response = requests.get(url=url, headers=headers, params=params )
    return response


"""
makes a GET request for each pkg name,
stores response in "<pkgname> + .json"
"""


def get_packages_by_names():
    try:
        f = open(FOLDER_PACKAGES + 'packages-names.json')
        pkg_names = json.load(f)

        for pkg_name in pkg_names:
            page_counter_fixed, page_counter_affected = 1, 1
            pkg_type = pkg_name.replace("pkg:", "")
            url = BASE_URL + "packages/"
            print("Now looking for: " + pkg_type)

            # looking for all packages of a package type with fixed vulnerabilities
            if not os.path.exists("data/packages/" + pkg_type):
                os.mkdir("data/packages/" + pkg_type)

            if not os.path.exists("data/packages/" + pkg_type + "/fixed"):
                os.mkdir("data/packages/" + pkg_type + "/fixed")

            response = get_package_data_by_name(pkg_type, url, True)
            file_path = FOLDER_PACKAGES + pkg_type + "/fixed" + "/" + str(
                page_counter_fixed) + "-fixed-" + pkg_type + ".json"
            with open(file_path, "w") as outfile:
                json.dump(response.json(), outfile, indent=4)

            while response.json()["next"] is not None and page_counter_fixed < 5:
                page_counter_fixed += 1
                response = get_package_data_by_name(pkg_type, response.json()["next"], True)
                file_path = FOLDER_PACKAGES + pkg_type + "/fixed" + "/" + str(
                    page_counter_fixed) + "-fixed-" + pkg_type + ".json"
                with open(file_path, "w") as outfile:
                    json.dump(response.json(), outfile, indent=4)

            # looking for all packages affected by vulnerabilities
            if not os.path.exists("data/packages/" + pkg_type + "/affected"):
                os.mkdir("data/packages/" + pkg_type + "/affected")

            response = get_package_data_by_name(pkg_type, url, False)
            file_path = FOLDER_PACKAGES + pkg_type + "/affected" + "/" + str(
                page_counter_affected) + "-affected-" + pkg_type + ".json"

            with open(file_path, "w") as outfile:
                json.dump(response.json(), outfile, indent=4)

            while response.json()["next"] is not None and page_counter_affected < 5:
                page_counter_affected += 1
                response = get_package_data_by_name(pkg_type, response.json()["next"], False)
                file_path = FOLDER_PACKAGES + pkg_type + "/affected" + "/" + str(
                    page_counter_affected) + "-affected-" + pkg_type + ".json"
                with open(file_path, "w") as outfile:
                    json.dump(response.json(), outfile, indent=4)

    except FileNotFoundError:
        traceback.print_exception(*sys.exc_info())


def get_all_vulnerabilities_by_page(url):
    params = {"page_size": 400000}
    response = requests.get(url=url, headers=headers, params=params, )
    return response


def get_all_vulnerabilities():
    page_counter = 1
    print("now downloading page: " + str(page_counter))
    url = BASE_URL + "vulnerabilities/"
    response = get_all_vulnerabilities_by_page(url)
    file_path = FOLDER_VULNERABILITIES + str(page_counter) + "-vulnerabilities.json"
    with open(file_path, "w") as outfile:
        json.dump(response.json(), outfile, indent=4)

    while response.json()["next"] is not None and page_counter < 100:
        page_counter += 1
        print("now downloading page: " + str(page_counter))
        response = get_all_vulnerabilities_by_page(response.json()["next"])
        file_path = FOLDER_VULNERABILITIES + str(page_counter) + "-vulnerabilities.json"
        with open(file_path, "w") as outfile:
            json.dump(response.json(), outfile, indent=4)

get_all_vulnerabilities()
